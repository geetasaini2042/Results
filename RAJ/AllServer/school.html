<!DOCTYPE html>
<html>
<head>
    <title>School Result</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; }
        #loading, #resultSection { text-align: center; margin-top: 40px; }
        .dot { animation: blink 1s infinite; font-size: 24px; color: blue; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }

        .table-container { overflow-x: auto; width: 100%; margin-top: 20px; }
        table.enhancedTable {
            min-width: 1000px; border-collapse: collapse; font-size: 12px; margin: auto;
        }
        table.enhancedTable th, table.enhancedTable td {
            border: 1px solid #ccc; padding: 6px; text-align: center; white-space: nowrap;
        }
        table.enhancedTable th { background-color: #007bff; color: white; }
        table.enhancedTable tr:nth-child(even) { background-color: #f9f9f9; }
        table.enhancedTable tr:hover { background-color: #f1f1f1; }
        .green { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }

        @media print {
            body * { visibility: hidden; }
            #resultSection, #resultSection * { visibility: visible; }
            #resultSection { position: absolute; left: 0; right: 0; margin: auto; width: fit-content; }
            #backBtn { display: none !important; }
        }

        #backBtn {
            position: fixed; top: 10px; left: 10px; font-size: 24px; color: blue;
            background: none; border: none; cursor: pointer; display: none;
        }
    </style>
</head>
<body>

<div id="loading" style="display:none;">
    <p><span id="progressText">Processing: 0%</span></p>
    <p><span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></p>
</div>

<div id="errorMsg" style="display:none; color: red; text-align: center; margin-top: 20px;"></div>

<div id="resultSection" style="display:none;">
    <button id="backBtn" onclick="goBack()">‚Üê</button>
    <h3 id="schoolName" style="color: #007bff; text-align: center;"></h3>
    <div id="result"></div>
</div>

<!-- Hidden inputs populated via URL -->
<input type="hidden" id="roll1">
<input type="hidden" id="roll2">
<input type="hidden" id="year">
<input type="hidden" id="wb_id">
<input type="hidden" id="source">

<script>
async function fetchResult(roll, year, wb_id, source) {
    const url = `https://manish-bhaiyas-bot.onrender.com/result?roll_no=${roll}&year=${year}&wb_id=${wb_id}&source=${source}`;
    try {
        const res = await fetch(url);
        const data = await res.json();
        return data.status !== "fail" ? data : null;
    } catch {
        return null;
    }
}

async function checkResult() {
    const roll1 = document.getElementById("roll1").value.trim();
    const roll2 = document.getElementById("roll2").value.trim();
    const year = document.getElementById("year").value.trim();
    const wb_id = document.getElementById("wb_id").value.trim();
    const source = document.getElementById("source").value.trim();

    const resultTableBody = document.querySelector("#resultTable tbody");
    resultTableBody.innerHTML = "";

    const students = [];
    const subjectSums = {};
    const maxSubjectMarks = {};
    let totalMarksSum = 0;

    // Get dynamic subjects from the first student's response
    const firstValid = (await fetchResult(roll1, year, wb_id, source))?.data?.board_result?.subjects || [];
    const subjects = firstValid
        .filter(sub => sub.subject_name && sub.subject_name.trim() !== "")
        .map(sub => sub.subject_name.trim());

    if (subjects.length === 0) {
        alert("No valid subjects found in the API response.");
        return;
    }

    for (let roll = parseInt(roll1); roll <= parseInt(roll2); roll++) {
        const result = await fetchResult(roll, year, wb_id, source);
        const data = result?.data;

        if (data?.board_result?.student_name && data?.board_result?.subjects) {
            const student = {
                roll: data.board_result.roll_number,
                name: data.board_result.student_name,
                marks: {},
                total: 0
            };

            const subjectsData = data.board_result.subjects;

            subjectsData.forEach(sub => {
                const name = sub.subject_name?.trim();
                if (!name) return;

                let finalMark = sub.theory_seasional;
                if (!finalMark || finalMark.trim() === "") {
                    finalMark = "Absent";
                } else {
                    finalMark = parseInt(finalMark) + parseInt(sub.practical || "0");
                    subjectSums[name] = (subjectSums[name] || 0) + finalMark;
                    maxSubjectMarks[name] = Math.max(maxSubjectMarks[name] || 0, finalMark);
                    student.total += finalMark;
                }

                student.marks[name] = finalMark;
            });

            totalMarksSum += student.total;
            students.push(student);
        }
    }

    students.sort((a, b) => b.total - a.total);

    students.forEach((student, index) => {
        const row = document.createElement("tr");

        const rankCell = document.createElement("td");
        rankCell.textContent = index + 1;
        row.appendChild(rankCell);

        const rollCell = document.createElement("td");
        rollCell.textContent = student.roll;
        row.appendChild(rollCell);

        const nameCell = document.createElement("td");
        nameCell.textContent = student.name;
        row.appendChild(nameCell);

        subjects.forEach(subject => {
            const markCell = document.createElement("td");
            const mark = student.marks[subject];
            markCell.textContent = mark;
            if (mark === "Absent") {
                markCell.classList.add("absent");
            } else if (mark === maxSubjectMarks[subject]) {
                markCell.classList.add("highlight");
            }
            row.appendChild(markCell);
        });

        const totalCell = document.createElement("td");
        totalCell.textContent = student.total;
        row.appendChild(totalCell);

        resultTableBody.appendChild(row);
    });

    // Optionally display average and top marks per subject if needed
}

function generateTable(students, subjects, subjectSums, maxSubjectMarks, totalMarksSum, studentCount) {
    let html = "<table class='enhancedTable'><tr><th>Rank</th><th>S.N.</th><th>Name</th><th>Roll No</th>";
    subjects.forEach(sub => html += `<th>${sub}</th>`);
    html += "<th>Total</th><th>Max</th><th>%</th></tr>";

    students.sort((a, b) => b.total - a.total);
    const rankMap = {};
    let rank = 1;
    students.forEach(stu => {
        const t = stu.total;
        if (!rankMap[t]) rankMap[t] = rank;
        rank++;
    });

    students.sort((a, b) => a.roll_no - b.roll_no);
    let sn = 1;
    students.forEach(stu => {
        html += `<tr><td>${rankMap[stu.total]}</td><td>${sn++}</td><td>${stu.name}</td><td>${stu.roll_no}</td>`;
        subjects.forEach(sub => {
            const m = stu.marks[sub];
            const highlight = (typeof m === "number" && m === maxSubjectMarks[sub]) ? "class='green'" : "";
            html += `<td ${highlight}>${m === "Absent" ? "<span class='fail'>Absent</span>" : m}</td>`;
        });
        html += `<td>${stu.total}</td><td>${subjects.length * 100}</td><td>${stu.percentage === "Failed" ? "<span class='fail'>Failed</span>" : stu.percentage + "%"}</td></tr>`;
    });

    html += `<tr style='font-weight:bold;'><td colspan='4'>Total Marks</td>`;
    subjects.forEach(sub => html += `<td>${subjectSums[sub]}</td>`);
    html += `<td>${totalMarksSum}</td><td>-</td><td>-</td></tr>`;

    html += `<tr style='font-weight:bold;'><td colspan='4'>Max Marks</td>`;
    subjects.forEach(() => html += `<td>${studentCount * 100}</td>`);
    html += `<td>${studentCount * subjects.length * 100}</td><td>-</td><td>-</td></tr>`;

    html += `<tr style='background-color:#d9edf7; font-weight:bold;'><td colspan='4'>Subject %</td>`;
    subjects.forEach(sub => {
        const percent = (subjectSums[sub] / (studentCount * 100)) * 100;
        html += `<td>${percent.toFixed(2)}%</td>`;
    });
    const overall = (totalMarksSum / (studentCount * subjects.length * 100)) * 100;
    html += `<td colspan='3'><strong>Overall: ${overall.toFixed(2)}%</strong></td></tr></table>`;

    return `<div class="table-container">${html}</div>`;
}

// Auto-fetch from URL
window.onload = async function () {
    const params = new URLSearchParams(window.location.search);
    const roll1 = parseInt(params.get('roll_no1'));
    const roll2 = parseInt(params.get('roll_no2'));
    const year = params.get('year') || '2024';
    const wb_id = params.get('wb_id') || '88';
    const source = params.get('source') || 'app';
    const printFlag = params.has('print');

    const errorMsg = document.getElementById('errorMsg');
    errorMsg.style.display = 'none';

    if (isNaN(roll1) || isNaN(roll2) || (roll2 - roll1 > 80)) {
        errorMsg.innerText = "Roll number range must be 80 or less.";
        errorMsg.style.display = 'block';
        return;
    }

    const testUrl = `https://manish-bhaiyas-bot.onrender.com/result?roll_no=${roll1}&year=${year}&wb_id=${wb_id}&source=${source}`;
    try {
        const res = await fetch(testUrl);
        const data = await res.json();
        if (!data || data.status === "fail") {
            errorMsg.innerText = `No data found for Roll No. ${roll1}`;
            errorMsg.style.display = 'block';
            return;
        }
    } catch {
        errorMsg.innerText = "Failed to connect to server.";
        errorMsg.style.display = 'block';
        return;
    }

    document.getElementById('roll1').value = roll1;
    document.getElementById('roll2').value = roll2;
    document.getElementById('year').value = year;
    document.getElementById('wb_id').value = wb_id;
    document.getElementById('source').value = source;

    await checkResult();

    if (printFlag) {
        window.print();
    }
};
</script>
</body>
</html>
