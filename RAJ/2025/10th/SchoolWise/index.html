<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Result Report</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #inputSection { text-align: center; padding: 20px; }
    #resultsTable, th, td { border: 1px solid black; border-collapse: collapse; }
    #resultsTable { width: 100%; margin-top: 20px; }
    th, td { padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .green { color: green; font-weight: bold; }
    .red { color: red; }
    #loading { text-align: center; font-size: 18px; margin-top: 20px; display: none; }
    #backIcon { display: none; position: fixed; top: 10px; left: 10px; font-size: 24px; color: blue; cursor: pointer; }
    #schoolTitle { text-align: center; font-size: 24px; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body><div id="backIcon" onclick="location.reload()">‚Üê</div>
<div id="inputSection">
  <div id="loading">Loading<span id="dots"></span><br><span id="progress"></span></div>
</div><div id="schoolTitle"></div>
<div id="tableContainer"></div><script>
const subjects = ['Hindi', 'English', 'Science', 'S.S.T', 'Maths', 'Sanskrit'];
const roll_no1 = new URLSearchParams(window.location.search).get("roll_no1");
const roll_no2 = new URLSearchParams(window.location.search).get("roll_no2");
const year = new URLSearchParams(window.location.search).get("year");
const wb_id = "88";
const source = "1";

const tableContainer = document.getElementById("tableContainer");
const inputSection = document.getElementById("inputSection");
const loading = document.getElementById("loading");
const progressText = document.getElementById("progress");
const schoolTitle = document.getElementById("schoolTitle");

let subjectSums = Object.fromEntries(subjects.map(s => [s, 0]));
let maxSubjectMarks = Object.fromEntries(subjects.map(s => [s, 0]));
let students = [];
let totalMarksSum = 0;
let studentCount = 0;

async function fetchResult(roll) {
  let url = `https://result.appanalytics.co.in/api/get-result?tag=raj_10th_result&roll_no=${roll}&year=${year}&wb_id=${wb_id}&source=${source}`;
  try {
    let response = await fetch(url);
    let data = await response.json();
    if (data.status === 'success') return data.data.board_result;
  } catch {}
  return null;
}

function updateDots() {
  const dots = document.getElementById("dots");
  dots.innerText = dots.innerText.length < 3 ? dots.innerText + '.' : '';
}

function setProgress(done, total) {
  progressText.innerText = `Processing: ${done}/${total} (${Math.round((done/total)*100)}%)`;
}

async function loadResults() {
  loading.style.display = "block";
  let dotInterval = setInterval(updateDots, 500);
  let total = parseInt(roll_no2) - parseInt(roll_no1) + 1;
  let rankMap = {};
  let rollStart = parseInt(roll_no1);
  let rollEnd = parseInt(roll_no2);

  for (let roll = rollStart; roll <= rollEnd; roll++) {
    let result = await fetchResult(roll);
    setProgress(roll - rollStart + 1, total);
    if (result) {
      if (!schoolTitle.innerText) schoolTitle.innerText = `School Name: ${result.candidate_info["School Name"]}`;
      let studentMarks = {};
      let marks = result.subjects.map(s => s.theory_seasional || "");
      let practicals = result.subjects.map(s => s.practical || "");
      let totalObtained = 0;
      let maxMarks = 0;
      subjects.forEach((sub, idx) => {
        let theory = marks[idx];
        let practical = practicals[idx];
        let finalMark = 0;
        if (theory === "") {
          studentMarks[sub] = "Absent";
        } else {
          finalMark = parseInt(theory);
          if (["Physics", "Chemistry"].includes(sub)) {
            finalMark += parseInt(practical || 0);
          }
          studentMarks[sub] = finalMark;
          subjectSums[sub] += finalMark;
          maxSubjectMarks[sub] = Math.max(maxSubjectMarks[sub], finalMark);
          totalObtained += finalMark;
          maxMarks += 100;
        }
      });

      let percent = result.result.percent || "Failed";
      students.push({
        name: result.candidate_info["Candidate Name"],
        roll_no: result.candidate_info["Roll No."],
        marks: studentMarks,
        total: result.result["Total Marks"] || totalObtained,
        max: maxMarks,
        percentage: percent
      });
      totalMarksSum += totalObtained;
      studentCount++;
    }
  }

  clearInterval(dotInterval);
  inputSection.style.display = "none";
  document.getElementById("backIcon").style.display = "block";
  generateTable();
}

function generateTable() {
  students.sort((a, b) => parseFloat(b.percentage) - parseFloat(a.percentage));
  let ranks = {};
  let rank = 1;
  students.forEach(s => {
    if (!ranks[s.percentage]) ranks[s.percentage] = rank;
    rank++;
  });
  students.sort((a, b) => parseInt(a.roll_no) - parseInt(b.roll_no));

  let html = `<table id='resultsTable'><tr><th>Rank</th><th>S.N.</th><th>Name</th><th>Roll No</th>`;
  subjects.forEach(sub => html += `<th>${sub}</th>`);
  html += `<th>Total</th><th>Max Marks</th><th>Percentage</th></tr>`;

  let sn = 1;
  students.forEach(s => {
    html += `<tr><td>${ranks[s.percentage]}</td><td>${sn++}</td><td>${s.name}</td><td>${s.roll_no}</td>`;
    subjects.forEach(sub => {
      let val = s.marks[sub];
      let display = val === undefined || val === "" ? "-" : val;
      if (display === "Absent") display = `<span class='red'>Absent</span>`;
      html += `<td>${display}</td>`;
    });
    html += `<td>${s.total || "-"}</td><td>${s.max || "-"}</td><td>${s.percentage}</td></tr>`;
  });

  html += `<tr style='font-weight:bold;'><td colspan='4'>Subject Total</td>`;
  subjects.forEach(sub => html += `<td>${subjectSums[sub]}</td>`);
  html += `<td>${totalMarksSum}</td><td>-</td><td>-</td></tr>`;

  html += `<tr style='font-weight:bold;'><td colspan='4'>Subject Percentage</td>`;
  subjects.forEach(sub => {
    let percent = ((subjectSums[sub] / (studentCount * 100)) * 100).toFixed(2);
    html += `<td>${percent}%</td>`;
  });
  html += `<td colspan='3'>School Overall: ${(totalMarksSum / (studentCount * subjects.length)).toFixed(2)}%</td></tr>`;
  html += `</table>`;
  tableContainer.innerHTML = html;
}

loadResults();
</script></body>
</html>
