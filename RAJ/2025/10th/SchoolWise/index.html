<!DOCTYPE html>
<html>
<head>
    <title>Live School Result Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; }

        #inputSection, #loading, #resultSection {
            text-align: center;
            margin-top: 40px;
        }

        button { padding: 10px 20px; font-size: 16px; }

        #backBtn {
            position: fixed;
            top: 10px;
            left: 10px;
            font-size: 24px;
            color: blue;
            background: none;
            border: none;
            cursor: pointer;
            display: none;
        }

        .green { color: green; font-weight: bold; }
        .dot { animation: blink 1s infinite; font-size: 24px; color: blue; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes blink {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        .table-container {
            overflow-x: auto;
            width: 100%;
            margin-top: 20px;
        }

        table.enhancedTable {
            min-width: 1000px;
            width: max-content;
            border-collapse: collapse;
            font-size: 12px;
        }

        table.enhancedTable th, table.enhancedTable td {
            border: 1px solid #ccc;
            padding: 6px;
            text-align: center;
            white-space: nowrap;
        }

        table.enhancedTable th {
            background-color: #007bff;
            color: white;
        }

        table.enhancedTable tr:nth-child(even) { background-color: #f9f9f9; }
        table.enhancedTable tr:hover { background-color: #f1f1f1; }

        .fail { color: red; font-weight: bold; }

        @media print {
            body { font-size: 10pt; }
            #backBtn, #inputSection, #print { display: none !important; }
            table { page-break-inside: avoid; }
            #schoolName { text-align: center !important; }
        }
    </style>

    <!-- JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

<div id="inputSection">
    <h2>Check School Results</h2>
    Roll No. Start: <input type="number" id="roll1"><br><br>
    Roll No. End: <input type="number" id="roll2"><br><br>
    Year: <input type="text" id="year" value="2024"><br><br>
    WB ID: <input type="text" id="wb_id" value="88"><br><br>
    Source: <input type="text" id="source" value="app"><br><br>
    <button onclick="checkResult()">Check Result</button>
</div>

<div id="loading" style="display:none;">
    <p><span id="progressText">Processing: 0%</span></p>
    <p><span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></p>
</div>

<div id="resultSection" style="display:none;">
    <button id="backBtn" onclick="goBack()">‚Üê</button>
    <h3 id="schoolName" style="color: #007bff; text-align: center;"></h3>
    <div id="result"></div>
</div>

<div id="print" style="display:none; text-align: center; margin-top: 20px;">
    <button onclick="downloadPDF()" style="background-color: #28a745; color: white; font-size: 16px; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
        Download as PDF
    </button>
</div>

<script>
async function fetchResult(roll, year, wb_id, source) {
    const url = `https://result.appanalytics.co.in/api/get-result?tag=raj_10th_result&roll_no=${roll}&year=${year}&wb_id=${wb_id}&source=${source}`;
    try {
        const res = await fetch(url);
        const data = await res.json();
        return data.status !== "fail" ? data : null;
    } catch {
        return null;
    }
}

async function checkResult() {
    const roll1 = parseInt(document.getElementById('roll1').value);
    const roll2 = parseInt(document.getElementById('roll2').value);
    const year = document.getElementById('year').value;
    const wb_id = document.getElementById('wb_id').value;
    const source = document.getElementById('source').value;

    const subjects = wb_id === "88"
        ? ['Hindi', 'English', 'Science', 'S.S.T', 'Maths', 'Sanskrit']
        : ['Hindi (Comp.)', 'English (Comp.)', 'Physics', 'Chemistry', 'Mathematics'];

    const students = [];
    const subjectSums = Object.fromEntries(subjects.map(s => [s, 0]));
    const maxSubjectMarks = Object.fromEntries(subjects.map(s => [s, 0]));
    let totalMarksSum = 0;
    let studentCount = 0;

    document.getElementById('loading').style.display = 'block';
    document.getElementById('inputSection').style.display = 'none';
    document.getElementById('resultSection').style.display = 'none';

    for (let roll = roll1; roll <= roll2; roll++) {
        const percentDone = Math.round(((roll - roll1 + 1) / (roll2 - roll1 + 1)) * 100);
        document.getElementById('progressText').innerText = `Processing: ${percentDone}%`;

        const data = await fetchResult(roll, year, wb_id, source);
        if (!data) continue;

        const result = data.data.board_result;
        const subjectsData = result.subjects;
        const student = {
            name: result.candidate_info["Candidate Name"],
            roll_no: result.candidate_info["Roll No."],
            school: result.candidate_info["School Name"] || "",
            marks: {},
            total: parseInt(result.result["Total Marks"] || "0"),
            percentage: result.result["percent"] || "Failed"
        };

        subjects.forEach((subject, i) => {
            const sub = subjectsData[i] || {};
            let theory = sub.theory_seasional;
            let practical = sub.practical;
            let finalMark;

            if (theory === "" || theory === undefined) {
                finalMark = "Absent";
            } else {
                theory = parseInt(theory);
                practical = parseInt(practical || "0");
                finalMark = (subject === 'Physics' || subject === 'Chemistry') ? theory + practical : theory;

                subjectSums[subject] += finalMark;
                maxSubjectMarks[subject] = Math.max(maxSubjectMarks[subject], finalMark);
            }

            student.marks[subject] = finalMark;
        });

        totalMarksSum += student.total;
        students.push(student);
        studentCount++;
    }

    document.getElementById('loading').style.display = 'none';
    document.getElementById('resultSection').style.display = 'block';
    document.getElementById('backBtn').style.display = 'block';
    document.getElementById('print').style.display = 'block';

    if (students.length > 0) {
        document.getElementById('schoolName').innerText = students[0].school;
    }

    document.getElementById('result').innerHTML = generateTable(students, subjects, subjectSums, maxSubjectMarks, totalMarksSum, studentCount);
}

function goBack() {
    document.getElementById('inputSection').style.display = 'block';
    document.getElementById('resultSection').style.display = 'none';
    document.getElementById('backBtn').style.display = 'none';
    document.getElementById('schoolName').innerText = "";
    document.getElementById('print').style.display = 'none';
}

function generateTable(students, subjects, subjectSums, maxSubjectMarks, totalMarksSum, studentCount) {
    let html = "<table class='enhancedTable'><tr><th>Rank</th><th>S.N.</th><th>Name</th><th>Roll No</th>";
    subjects.forEach(sub => html += `<th>${sub}</th>`);
    html += "<th>Total</th><th>Max</th><th>%</th></tr>";

    students.sort((a, b) => b.total - a.total);
    const rankMap = {};
    let rank = 1;
    students.forEach(stu => {
        const t = stu.total;
        if (!rankMap[t]) rankMap[t] = rank;
        rank++;
    });

    students.sort((a, b) => a.roll_no - b.roll_no);
    let sn = 1;
    students.forEach(stu => {
        html += `<tr><td>${rankMap[stu.total]}</td><td>${sn++}</td><td>${stu.name}</td><td>${stu.roll_no}</td>`;
        subjects.forEach(sub => {
            const m = stu.marks[sub];
            const highlight = (typeof m === "number" && m === maxSubjectMarks[sub]) ? "class='green'" : "";
            html += `<td ${highlight}>${m === "Absent" ? "<span class='fail'>Absent</span>" : m}</td>`;
        });
        html += `<td>${stu.total}</td><td>${subjects.length * 100}</td><td>${stu.percentage === "Failed" ? "<span class='fail'>Failed</span>" : stu.percentage + "%"}</td></tr>`;
    });

    html += `<tr style='font-weight:bold;'><td colspan='4'>Total Marks</td>`;
    subjects.forEach(sub => html += `<td>${subjectSums[sub]}</td>`);
    html += `<td>${totalMarksSum}</td><td>-</td><td>-</td></tr>`;

    html += `<tr style='font-weight:bold;'><td colspan='4'>Max Marks</td>`;
    subjects.forEach(() => html += `<td>${studentCount * 100}</td>`);
    html += `<td>${studentCount * subjects.length * 100}</td><td>-</td><td>-</td></tr>`;

    html += `<tr style='background-color:#d9edf7; font-weight:bold;'><td colspan='4'>Subject %</td>`;
    subjects.forEach(sub => {
        const percent = (subjectSums[sub] / (studentCount * 100)) * 100;
        html += `<td>${percent.toFixed(2)}%</td>`;
    });
    const overall = (totalMarksSum / (studentCount * subjects.length * 100)) * 100;
    html += `<td colspan='3'><strong>Overall: ${overall.toFixed(2)}%</strong></td></tr></table>`;

    return `<div class="table-container">${html}</div>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;

    const resultSection = document.getElementById("resultSection");
    const schoolName = document.getElementById("schoolName").innerText;
    const tableHTML = document.querySelector(".table-container").innerHTML;

    const temp = document.createElement("div");
    temp.style.padding = "20px";
    temp.style.fontFamily = "Arial";
    temp.style.backgroundColor = "white";
    temp.innerHTML = `<h2 style="text-align:center; color:#007bff;">${schoolName}</h2>${tableHTML}`;
    document.body.appendChild(temp);

    const canvas = await html2canvas(temp, { scale: 2 });

    const imgData = canvas.toDataURL("image/png");
    const imgWidth = 760;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'pt',
        format: [800, 1200]
    });

    if (imgHeight > 1140) {
        let position = 20;
        while (position < imgHeight) {
            doc.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
            if (position + 1140 < imgHeight) doc.addPage();
            position += 1140;
        }
    } else {
        doc.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
    }

    document.body.removeChild(temp);
    doc.save(`${schoolName}_Result.pdf`);
}
</script>

</body>
</html>
